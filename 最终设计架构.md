# CDSP-MoE 技术架构白皮书 (Technical Architecture Document)

**项目名称**: Conflict-Driven Subspace Pruning Mixture-of-Experts (CDSP-MoE)

**核心理念**: 通过基于“滞后梯度博弈”的内生演化压力，替代传统 MoE 的外在负载均衡约束，实现神经网络拓扑结构的自组织特化与层级化。

---

## 1. 物理层：共享子空间基座 (Physical Subspace Backbone)

传统 MoE 中每个专家拥有独立的权重矩阵，而 CDSP 采用“超完备共享基座”设计。

* **定义**: 物理基座由两个正交初始化的超大矩阵组成：

其中  (代码中 )。
* **物理分区 ()**:
* 系统维护一个固定缓冲区 `self.pi` ()，用于定义专家的“原生领地”。
* **初始化策略**: 块状对角 (Block Diagonal)。专家  初始独占区间 ，其中 。



---

## 2. 拓扑层：动态权力网络 (Topology Layer)

这是系统的“政治地图”，决定了专家如何调用物理资源以及专家之间的结盟关系。

* **拓扑矩阵 ()**:
* 参数 `self.alpha` ()。
* **物理意义**:  表示专家  对专家  原生领地的**借用权**或**依赖度**。


* **雕塑法初始化 (Sculpting Initialization)**:
* 不同于随机初始化，采用“先连接后剪枝”策略。
* **对角线 (Self)**:  (强自指，保证独立生存能力)。
* **非对角线 (Alliances)**:  (弱连接 + 噪声，允许梯度初期流动)。
* **代码对应**: `topology.py` 中的 `_reset_parameters`。


* **影响力投影 (Influence Projection)**:
专家  对物理维度的实际控制力  计算如下：


---

## 3. 感知路由层 (Perceptive Routing Layer)

路由不再仅仅基于 Token 内容，而是显式注入了**任务意图**，实现了“看人下菜碟”。

* **任务感知输入**:

* **门控决策**:


* **代码对应**: `layer.py` 中的 `_compute_router_logits`。



---

## 4. 前向传播动力学 (Forward Dynamics)

当专家  被激活处理输入  时，执行以下**动态子空间计算**流程：

1. **资源寻址 (Addressing)**:
根据影响力  选取 Top- 个物理维度索引  (Rank Quota )。

* **代码对应**: `topology.py` -> `get_subspace_indices`。


2. **子空间计算 (Computation)**:
仅提取  对应的基座切片进行运算。

* **代码对应**: `backbone.py` -> `forward` (使用 `index_select`)。


3. **权限调制 (Authority Modulation)**:
这是 Alpha 矩阵的第二重作用——即使 Router 选中了你，如果你对资源的掌控力很弱，你的输出也会被抑制。


* **代码对应**: `layer.py` 中 `token_outputs * gate_score`。



---

## 5. 滞后梯度博弈 (Lagged Gradient Game)

这是 CDSP 的核心演化引擎。它利用**上一轮**的梯度信息，在**当前轮**的前向传播中计算冲突惩罚。

### 5.1 梯度捕获 (Gradient Capture)

利用 PyTorch Hook 机制，在反向传播时捕获每个专家在物理基座上的梯度投影。

* **存储结构**: `expert_grads[i] = (GradTensor, PhysicalIndices)`。
* **滞后性**: `optimizer.zero_grad()` 被特意安排在 `forward` 之后、`backward` 之前（见 `train_cdsp_mnist.py`）。这意味着 Forward 阶段读取的 `expert_grads` 实际上是 **Step t-1** 产生的梯度。

### 5.2 空间冲突计算 (Spatial Conflict Computation)

对于当前 Batch 中同时激活的一对专家 ，计算其在**物理重叠区域**的梯度余弦相似度。

1. **物理交集**: 。若交集为空，冲突为 0。
2. **稀疏对齐**: 仅提取交集  对应的梯度切片 。
3. **余弦相似度**:

4. **博弈惩罚**:

* **物理意义**: 只有当梯度方向**相反**（负余弦）时才视为冲突（内耗）。正交或同向视为无害或协作。
* **代码对应**: `conflict.py` -> `compute_sparse_aligned_cosine`。



---

## 6. 全局演化目标 (Evolutionary Objective)

总损失函数设计为引导系统向“低熵、低冲突、高特化”状态演化。

### 6.1 冲突剪枝损失

如果专家  依赖专家  ( 大)，但二者打架 ( 大)，则重罚 。

* **权重**: 在 `train_cdsp_mnist.py` 中硬编码为 `10.0`，极其强力。

### 6.2 系统正则化

1. **代谢成本 (Metabolic Cost)**: L1 范数，诱导稀疏。

2. **确定性惩罚 (Determinism)**: 最小化二元熵，迫使连接非黑即白。

* **代码对应**: `regularization.py`。



---

## 7. 优化与超参细节 (Optimization Implementation)

* **双速优化 (Two-Speed Optimization)**:
* **物理参数 ()**: 学习率 `0.005`，使用 Weight Decay `0.01`。
* **拓扑参数 ()**: 学习率 `0.05` (10倍速)，**无 Weight Decay**。
* **逻辑**: 政治体制（拓扑）的演变速度必须快于生产力（物理权重）的积累速度，以确保在过拟合前完成分工。


* **秩配额 (Rank Quota)**:
* 。在实验中，，则 。这保证了子空间足够大以容纳知识，又足够小以产生差异化。



---

## 总结

CDSP-MoE 架构通过 **Space (物理子空间)**、**Time (滞后梯度)** 和 **Structure (拓扑演化)** 三个维度的协同，成功在神经网络内部构建了一个**基于梯度的市场经济系统**。

* **Router** 是需求方（发单）。
* **Backbone** 是供给方（算力）。
* **Topology** 是契约关系（资源分配）。
* **Conflict Loss** 是市场调节机制（优胜劣汰）。